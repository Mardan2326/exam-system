<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PDF è¯•é¢˜æ¨¡æ‹Ÿè€ƒè¯•å™¨ (æœ¬åœ°æœåŠ¡å™¨ç‰ˆ)</title>
  <style>
    :root{font-family: system-ui,-apple-system,"PingFang SC","Microsoft YaHei",Arial;}
    body{margin:0;display:flex;flex-direction:column;gap:12px;height:100vh;padding:12px;background:#f6f7fb}
    main{flex:1;display:flex;flex-direction:column;gap:12px;overflow:hidden}
    header{display:flex;align-items:center;gap:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .panel{background:#fff;padding:12px;border-radius:8px;box-shadow:0 6px 18px rgba(20,30,60,0.06)}
    .quiz-container{flex:1;overflow-y:auto}
    .quiz{display:flex;flex-direction:column;gap:10px}
    .question{padding:10px;border-radius:6px;border:1px solid #eef2ff}
    .question-text{margin:10px 0;line-height:1.6}
    .options button{display:block;width:100%;margin:6px 0;padding:10px;border-radius:6px;border:1px solid #dbe7ff;background:#fff;cursor:pointer;text-align:left;transition:all 0.2s}
    .options button:hover{background:#f0f4ff}
    .options button.selected{background:#e6f0ff;border-color:#4a90e2}
    .options button.correct{background:#d4edda;border-color:#28a745}
    .options button.wrong{background:#f8d7da;border-color:#dc3545}
    footer{display:flex;gap:8px;align-items:center;padding-top:10px;border-top:1px solid #eee}
    .progress-bar{width:200px;height:20px;background:#eee;border-radius:10px;overflow:hidden;margin:0 10px}
    .progress-fill{height:100%;background:#4a90e2;transition:width 0.3s ease}
    .fixed-nav{position:fixed;bottom:20px;left:20px;z-index:1000;display:flex;gap:8px}
    .fixed-nav button{padding:10px 16px;background:#4a90e2;color:white;border:none;border-radius:6px;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
    .fixed-nav button:hover{background:#357abd}
    .fixed-nav button:disabled{opacity:0.5;cursor:not-allowed;background:#ccc}
    button{padding:8px 16px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer}
    button:hover{background:#f5f5f5}
    button:disabled{opacity:0.5;cursor:not-allowed}
    .file-upload{display:flex;align-items:center;gap:8px}
    .file-upload input[type="file"]{display:none}
    .file-upload label{padding:8px 16px;border-radius:6px;border:1px solid #4a90e2;background:#4a90e2;color:white;cursor:pointer}
    .file-upload label:hover{background:#357abd}
    .file-name{color:#666;font-size:14px}
    .debug{margin-top:10px;padding:10px;background:#f9f9f9;border-radius:4px;font-size:12px;max-height:200px;overflow-y:auto}
    .tip{background:#fff3cd;border:1px solid #ffc107;padding:10px;border-radius:6px;margin-bottom:10px}
  </style>
</head>
<body>
  <main>
    <header>
      <h2>ğŸ“ PDF è¯•é¢˜æ¨¡æ‹Ÿè€ƒè¯•å™¨ (æœ¬åœ°æœåŠ¡å™¨ç‰ˆ)</h2>
    </header>

    <div class="panel controls">
      <div class="file-upload">
        <label for="pdfFile">ğŸ“‚ 1. é€‰æ‹©PDFæ–‡ä»¶</label>
        <input type="file" id="pdfFile" accept=".pdf">
        <span class="file-name" id="fileName">æœªé€‰æ‹©æ–‡ä»¶</span>
      </div>
      <button id="loadBtn" disabled>2. å¼€å§‹è€ƒè¯• (æœ¬åœ°è§£æ-å¿«é€Ÿ)</button>
      <button id="aiParseBtn" disabled style="background-color: #5cb85c; color: white;" title="ä½¿ç”¨DeepSeek AIè§£æï¼Œæ›´å‡†ç¡®ä½†è¾ƒæ…¢ï¼ˆ1-3åˆ†é’Ÿï¼‰">2. å¼€å§‹è€ƒè¯• (AIè§£æ-æ¨è)</button>
      <button id="resetBtn">é‡ç½®</button>
      <label for="examDuration" style="margin-left: 16px;">è€ƒè¯•æ—¶é•¿(åˆ†é’Ÿ):</label>
      <input type="number" id="examDuration" value="90" style="width: 60px;">
      <strong style="margin-left: 16px;">å‰©ä½™æ—¶é—´: <span id="timer" style="color: #d9534f;">--:--</span></strong>
      <label><input type="checkbox" id="debugMode"> æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯</label>
      <button id="viewTextBtn" disabled>æŸ¥çœ‹åŸå§‹æ–‡æœ¬</button>
      <button id="submitExamBtn" disabled>æäº¤è¯•å·</button>
    </div>

    <div class="panel quiz-container">
      <div class="tip">
        ğŸ’¡ <strong>ä½¿ç”¨æç¤ºï¼š</strong>
        <br>1. è¿è¡Œæœ¬åœ°PythonæœåŠ¡å™¨ (è¿è¡Œ `python server.py`)ã€‚
        <br>2. ç‚¹å‡»"é€‰æ‹©PDFæ–‡ä»¶"æŒ‰é’®ï¼Œé€‰æ‹©ä½ çš„è¯•é¢˜PDFã€‚
        <br>3. <strong>æ¨èä½¿ç”¨ "AIè§£æ"</strong>ï¼šæ›´å‡†ç¡®è¯†åˆ«é¢˜ç›®å’Œç­”æ¡ˆï¼Œä½†éœ€è¦ 1-3 åˆ†é’Ÿå¤„ç†æ—¶é—´ã€‚
        <br>4. æˆ–ä½¿ç”¨ "æœ¬åœ°è§£æ"ï¼šé€Ÿåº¦å¿«ï¼ˆå‡ ç§’ï¼‰ï¼Œä½†å‡†ç¡®ç‡è¾ƒä½ï¼Œé€‚åˆæ ¼å¼è§„èŒƒçš„PDFã€‚
        <br>5. âš ï¸ <strong>é‡è¦ï¼š</strong> AIè§£æå¤„ç†å¤§æ–‡ä»¶æ—¶è¯·è€å¿ƒç­‰å¾…ï¼Œä¸è¦å…³é—­é¡µé¢ã€‚å»ºè®®æ¯æ¬¡å¤„ç†ä¸è¶…è¿‡20é¡µã€‚
      </div>
      <div id="status">è¯·å…ˆè¿è¡Œæœ¬åœ°PythonæœåŠ¡å™¨, ç„¶åé€‰æ‹©PDFæ–‡ä»¶</div>
      <div id="debug" class="debug" style="display:none"></div>
      <div id="quiz" class="quiz"></div>
      <footer>
        <span id="progress" style="margin-left:10px"></span>
        <div class="progress-bar">
          <div id="progressFill" class="progress-fill" style="width:0%"></div>
        </div>
        <div id="score" style="margin-left:auto">ç­”é¢˜è¿›åº¦ï¼š0 / 0 é“é¢˜</div>
      </footer>
    </div>
  </main>

  <div class="fixed-nav">
    <button id="prevQ" disabled>ä¸Šä¸€é¢˜</button>
    <button id="nextQ" disabled>ä¸‹ä¸€é¢˜</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const statusEl = document.getElementById('status');
    const quizEl = document.getElementById('quiz');
    const scoreEl = document.getElementById('score');
    const debugEl = document.getElementById('debug');
    const progressEl = document.getElementById('progress');
    const fileNameEl = document.getElementById('fileName');
    const loadBtn = document.getElementById('loadBtn');
    const prevBtn = document.getElementById('prevQ');
    const nextBtn = document.getElementById('nextQ');
    const viewTextBtn = document.getElementById('viewTextBtn');
    const submitExamBtn = document.getElementById('submitExamBtn');
    const progressFillEl = document.getElementById('progressFill');
    const timerEl = document.getElementById('timer');
    const durationInput = document.getElementById('examDuration');
    const aiParseBtn = document.getElementById('aiParseBtn');

    let pdfFile = null;
    let questionBank = [];
    let currentIndex = 0;
    let userAnswers = {};
    let extractedText = '';
    let examSubmitted = false;
    let timerInterval = null;

    function log(msg){
      console.log(msg);
      if(document.getElementById('debugMode').checked){
        debugEl.style.display = 'block';
        debugEl.innerHTML += msg + '<br>';
        debugEl.scrollTop = debugEl.scrollHeight;
      }
    }

    function startTimer(duration, display) {
        let timer = duration, minutes, seconds;
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            display.textContent = minutes + ":" + seconds;
            if (--timer < 0) {
                clearInterval(timerInterval);
                alert('æ—¶é—´åˆ°ï¼è¯•å·å°†è‡ªåŠ¨æäº¤ã€‚');
                if (!submitExamBtn.disabled) submitExamBtn.onclick();
            }
        }, 1000);
    }

    document.getElementById('pdfFile').onchange = (e) => {
      const file = e.target.files[0];
      if(file && file.type === 'application/pdf'){
        pdfFile = file;
        fileNameEl.textContent = file.name;
        loadBtn.disabled = false;
        aiParseBtn.disabled = false;
        viewTextBtn.disabled = false;
        submitExamBtn.disabled = true;
        statusEl.textContent = 'å·²é€‰æ‹©æ–‡ä»¶ï¼Œè¯·ç‚¹å‡»ä¸€ä¸ªå¼€å§‹æŒ‰é’®';
        statusEl.style.color = '#666';
      } else {
        pdfFile = null;
        fileNameEl.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
        loadBtn.disabled = true;
        aiParseBtn.disabled = true;
        viewTextBtn.disabled = true;
        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„PDFæ–‡ä»¶ï¼');
      }
    };

    async function extractTextFromPDF(file){
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
      const arrayBuffer = await file.arrayBuffer();
      const loadingTask = pdfjsLib.getDocument({data: arrayBuffer});
      const pdf = await loadingTask.promise;
      log(`PDFåŠ è½½æˆåŠŸï¼Œå…± ${pdf.numPages} é¡µ`);
      let allText = '';
      for(let i=1; i<=pdf.numPages; i++){
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        allText += '\n' + pageText;
        log(`å·²æå–ç¬¬ ${i} é¡µ (${pageText.length} å­—ç¬¦)`);
      }
      log(`æ€»å…±æå– ${allText.length} ä¸ªå­—ç¬¦`);
      extractedText = allText;
      return allText;
    }

    function parseQuestionsFromText(text) {
      log('å¼€å§‹ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æé¢˜ç›®...');
      const parts = text.split(/å‚è€ƒç­”æ¡ˆ/);
      const questionsText = parts[0];
      const answersText = parts.length > 1 ? 'å‚è€ƒç­”æ¡ˆ' + parts.slice(1).join('å‚è€ƒç­”æ¡ˆ') : '';
      const answers = new Map();
      if (answersText) {
          log('å‘ç°ç­”æ¡ˆéƒ¨åˆ†ï¼Œå¼€å§‹è§£æç­”æ¡ˆ...');
          const answerRegex = /(\d+)\s*ã€.*?æ•…æ­£ç¡®ç­”æ¡ˆä¸º\s*([A-D])/g;
          let match;
          while ((match = answerRegex.exec(answersText)) !== null) {
              answers.set(match[1], match[2].toUpperCase());
          }
          log(`å…±è§£æå‡º ${answers.size} ä¸ªç­”æ¡ˆã€‚`);
      } else {
          log('è­¦å‘Šï¼šæœªåœ¨æ–‡æœ¬ä¸­æ‰¾åˆ° "å‚è€ƒç­”æ¡ˆ" æ ‡è¯†ï¼Œå°†å°è¯•åœ¨é¢˜ç›®å†…è§£æç­”æ¡ˆã€‚');
      }
      const questions = [];
      const splits = questionsText.split(/(?=\s*\d{1,3}\s*[ã€.ï¼])/);
      for (let i = 0; i < splits.length; i++) {
          const chunk = splits[i].trim();
          if (chunk.length < 10) continue;
          const idMatch = chunk.match(/^(\d{1,3})\s*[ã€.ï¼]/);
          if (!idMatch) continue;
          const id = idMatch[1];
          let remainText = chunk.substring(idMatch[0].length).trim();
          const optionPattern = /[A-D]\s*[ã€.ï¼]/g;
          const optionMatches = [...remainText.matchAll(optionPattern)];
          if (optionMatches.length < 2) continue;
          const firstOptionPos = optionMatches[0].index;
          const questionText = remainText.substring(0, firstOptionPos).trim();
          const options = {};
          for (let j = 0; j < optionMatches.length; j++) {
              const optMatch = optionMatches[j];
              const optKey = optMatch[0].charAt(0);
              const startPos = optMatch.index + optMatch[0].length;
              const endPos = j < optionMatches.length - 1 ? optionMatches[j + 1].index : remainText.length;
              let optText = remainText.substring(startPos, endPos).trim().replace(/(?:å‚è€ƒç­”æ¡ˆ|ç­”æ¡ˆ|æ­£ç¡®ç­”æ¡ˆ|è§£æ)[:ï¼š].*/gi, '').trim();
              if (optText.length > 0) options[optKey] = optText.substring(0, 200);
          }
          let finalAnswer = answers.get(id) || null;
          if (!finalAnswer) {
              const inlineAnswerMatch = remainText.match(/(?:å‚è€ƒç­”æ¡ˆ|ç­”æ¡ˆ|æ­£ç¡®ç­”æ¡ˆ|æ ‡å‡†ç­”æ¡ˆ|æ ‡å‡†|å‚è€ƒ|è§£æ)[:ï¼š]?\s*([A-D])/i);
              if (inlineAnswerMatch) finalAnswer = inlineAnswerMatch[1].toUpperCase();
          }
          if (questionText.length > 5 && Object.keys(options).length >= 2) {
              questions.push({ id, text: questionText.substring(0, 500), options, answer: finalAnswer });
          }
      }
      log(`<strong>(æœ¬åœ°)æ€»å…±è§£æå‡º ${questions.length} é“é¢˜ç›®</strong>`);
      return questions;
    }

    async function parseQuestionsWithAI(text) {
      log('æ­£åœ¨è¯·æ±‚æœ¬åœ°æœåŠ¡å™¨è¿›è¡ŒAIè§£æ...');
      log('<strong style="color: orange;">â³ DeepSeek æ­£åœ¨å¤„ç†ä¸­ï¼Œè¿™å¯èƒ½éœ€è¦ 1-3 åˆ†é’Ÿï¼Œè¯·è€å¿ƒç­‰å¾…...</strong>');
      
      // æ˜¾ç¤ºå¤„ç†æç¤º
      statusEl.innerHTML = 'ğŸ¤– <strong>AI æ­£åœ¨è§£æé¢˜ç›®...</strong><br><small>å¤„ç†å¤§é‡æ–‡æœ¬éœ€è¦è¾ƒé•¿æ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…ï¼ˆé¢„è®¡ 1-3 åˆ†é’Ÿï¼‰</small>';
      statusEl.style.color = 'orange';
      
      try {
        // å¢åŠ è¶…æ—¶æ—¶é—´åˆ° 3 åˆ†é’Ÿ
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 180000); // 180ç§’ = 3åˆ†é’Ÿ
        
        const response = await fetch('http://127.0.0.1:5000/parse', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: text }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status} - ${errorData.error || 'æœªçŸ¥é”™è¯¯'}`);
        }
        
        const questions = await response.json();
        log(`<strong style="color: green;">âœ… AIæˆåŠŸè§£æå‡º ${questions.length} é“é¢˜ç›®</strong>`);
        return questions;
      } catch (error) {
        if (error.name === 'AbortError') {
          log(`âŒ AIè§£æè¶…æ—¶ï¼ˆè¶…è¿‡3åˆ†é’Ÿï¼‰ã€‚å»ºè®®ï¼š1) å‡å°‘PDFé¡µæ•° 2) æ£€æŸ¥ç½‘ç»œè¿æ¥ 3) å°è¯•ä½¿ç”¨"æœ¬åœ°è§£æ"æŒ‰é’®`);
          statusEl.innerHTML = 'âŒ <strong>AIè§£æè¶…æ—¶</strong><br><small>å»ºè®®ä½¿ç”¨"æœ¬åœ°è§£æ"æˆ–ä¸Šä¼ è¾ƒå°‘é¡µæ•°çš„PDF</small>';
        } else {
          log(`âŒ AIè§£æå¤±è´¥: ${error.message}ã€‚è¯·ç¡®ä¿æœ¬åœ°PythonæœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”å·²å®‰è£…æ‰€éœ€åº“ (Flask, Flask-Cors, OpenAI)ã€‚`);
          statusEl.innerHTML = 'âŒ <strong>AIè§£æå¤±è´¥</strong><br><small>è¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ</small>';
        }
        statusEl.style.color = 'red';
        console.error(error);
        return null;
      }
    }

    function renderQuiz(qs){
      questionBank = qs;
      currentIndex = 0;
      userAnswers = {};
      quizEl.innerHTML = '';
      if(!qs || qs.length === 0){
        statusEl.innerHTML = 'âŒ æœªèƒ½è§£æå‡ºé¢˜ç›®ã€‚<br>è¯·æ£€æŸ¥PDFæ ¼å¼æˆ–æœåŠ¡å™¨æ—¥å¿—ï¼Œå¹¶æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯ã€‚';
        statusEl.style.color = 'red';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
        return;
      }
      statusEl.innerHTML = `âœ… æˆåŠŸåŠ è½½ <strong>${qs.length}</strong> é“é¢˜ç›®ï¼`;
      statusEl.style.color = 'green';
      scoreEl.innerHTML = 'ç­”é¢˜è¿›åº¦ï¼š0 / ' + qs.length + ' é“é¢˜ (0%)';
      progressFillEl.style.width = '0%';
      prevBtn.disabled = false;
      nextBtn.disabled = false;
      submitExamBtn.disabled = false;
      examSubmitted = false;
      showQuestion(0);
    }

    function showQuestion(i){
      if(i < 0 || i >= questionBank.length) return;
      currentIndex = i;
      const q = questionBank[i];
      quizEl.innerHTML = '';
      const div = document.createElement('div');
      div.className = 'question';
      div.innerHTML = `<strong style="font-size:16px">ç¬¬ ${i+1} é¢˜ / å…± ${questionBank.length} é¢˜ï¼ˆåŸé¢˜å· ${q.id}ï¼‰</strong>`;
      const questionText = document.createElement('div');
      questionText.className = 'question-text';
      questionText.textContent = q.text;
      div.appendChild(questionText);
      const opts = document.createElement('div');
      opts.className = 'options';
      const keys = Object.keys(q.options).sort();
      for(const key of keys){
        const btn = document.createElement('button');
        btn.innerHTML = `<strong>${key}.</strong> ${q.options[key]}`;
        if(userAnswers[q.id] === key) btn.classList.add('selected');
        btn.onclick = () => {
          if(examSubmitted) return;
          opts.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
          userAnswers[q.id] = key;
          btn.classList.add('selected');
          updateScore();
        };
        opts.appendChild(btn);
      }
      div.appendChild(opts);
      if(examSubmitted && q.answer){
        const answerHint = document.createElement('div');
        answerHint.style.marginTop = '10px';
        answerHint.style.color = '#28a745';
        answerHint.style.fontSize = '14px';
        answerHint.innerHTML = `<strong>âœ“ å‚è€ƒç­”æ¡ˆï¼š${q.answer}</strong>`;
        div.appendChild(answerHint);
      }
      quizEl.appendChild(div);
      updateProgress();
    }

    function updateScore(){
      let answered = Object.keys(userAnswers).length;
      let correct = 0;
      for(const q of questionBank){
        if(userAnswers[q.id]){
          if(examSubmitted && q.answer && userAnswers[q.id] === q.answer) correct++;
        }
      }
      if(examSubmitted){
        scoreEl.innerHTML = `å¾—åˆ†ï¼š<strong>${correct}</strong> / ${questionBank.length} <span style="color:#666">(æ­£ç¡®ç‡ï¼š${Math.round(correct/questionBank.length*100)}%)</span>`;
      } else {
        scoreEl.innerHTML = `ç­”é¢˜è¿›åº¦ï¼š<strong>${answered}</strong> / ${questionBank.length} <span style="color:#666">(${Math.round(answered/questionBank.length*100)}%)</span>`;
        progressFillEl.style.width = `${(answered/questionBank.length)*100}%`;
      }
    }

    function updateProgress(){
      progressEl.textContent = `${currentIndex + 1} / ${questionBank.length}`;
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex === questionBank.length - 1;
    }

    async function startExam(parserFunc) {
      if(!pdfFile) { alert('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶ï¼'); return; }
      statusEl.textContent = 'æ­£åœ¨åŠ è½½å’Œè§£æPDF...';
      statusEl.style.color = '#666';
      debugEl.innerHTML = '';
      loadBtn.disabled = true;
      aiParseBtn.disabled = true;
      
      try {
        const text = await extractTextFromPDF(pdfFile);
        const qs = await parserFunc(text);
        if (qs) {
          renderQuiz(qs);
          if (qs.length > 0) {
              let examDuration = parseInt(durationInput.value, 10) * 60;
              if (isNaN(examDuration) || examDuration <= 0) {
                  examDuration = 90 * 60;
                  durationInput.value = 90;
              }
              startTimer(examDuration, timerEl);
              durationInput.disabled = true;
          }
        }
      } catch(e) {
        statusEl.innerHTML = `âŒ åŠ è½½å¤±è´¥ï¼š${e.message}`;
        statusEl.style.color = 'red';
        log('é”™è¯¯ï¼š' + e.message);
        console.error(e);
      } finally {
        loadBtn.disabled = false;
        aiParseBtn.disabled = false;
      }
    }

    loadBtn.onclick = () => startExam(parseQuestionsFromText);
    aiParseBtn.onclick = () => startExam(parseQuestionsWithAI);

    document.getElementById('resetBtn').onclick = () => {
      if (timerInterval) clearInterval(timerInterval);
      timerEl.textContent = '--:--';
      durationInput.disabled = false;
      questionBank = [];
      userAnswers = {};
      examSubmitted = false;
      quizEl.innerHTML = '';
      debugEl.innerHTML = '';
      statusEl.textContent = 'å·²é‡ç½®ã€‚è¯·é‡æ–°é€‰æ‹©PDFæ–‡ä»¶ã€‚';
      statusEl.style.color = '#666';
      scoreEl.innerHTML = 'ç­”é¢˜è¿›åº¦ï¼š0 / 0 é“é¢˜ (0%)';
      progressFillEl.style.width = '0%';
      progressEl.textContent = '';
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      submitExamBtn.disabled = true;
    };

    nextBtn.onclick = () => { if(currentIndex < questionBank.length - 1) showQuestion(currentIndex + 1); };
    prevBtn.onclick = () => { if(currentIndex > 0) showQuestion(currentIndex - 1); };
    document.getElementById('debugMode').onchange = (e) => { debugEl.style.display = e.target.checked ? 'block' : 'none'; };

    viewTextBtn.onclick = async () => {
      if(!pdfFile) { alert('è¯·å…ˆé€‰æ‹©PDFæ–‡ä»¶ï¼'); return; }
      if(!extractedText) {
        statusEl.textContent = 'æ­£åœ¨æå–PDFæ–‡æœ¬...';
        viewTextBtn.disabled = true;
        try {
          extractedText = await extractTextFromPDF(pdfFile);
          statusEl.textContent = 'PDFæ–‡æœ¬æå–æˆåŠŸï¼';
        } catch(e) {
          statusEl.innerHTML = `âŒ æå–å¤±è´¥ï¼š${e.message}`;
        } finally {
          viewTextBtn.disabled = false;
        }
      }
      if(extractedText){
        const textWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
        textWindow.document.write(`<pre>${extractedText}</pre>`);
        textWindow.document.close();
      }
    };

    submitExamBtn.onclick = () => {
      if(questionBank.length === 0) { alert('è¯·å…ˆåŠ è½½é¢˜ç›®ï¼'); return; }
      const answered = Object.keys(userAnswers).length;
      const total = questionBank.length;
      if(answered < total && !examSubmitted){
        if(!confirm(`æ‚¨è¿˜æœ‰ ${total - answered} é“é¢˜æœªä½œç­”ï¼Œç¡®å®šè¦æäº¤è¯•å·å—ï¼Ÿ`)) return;
      }
      if (timerInterval) clearInterval(timerInterval);
      examSubmitted = true;
      submitExamBtn.disabled = true;
      let correct = 0;
      let details = '';
      for(let i = 0; i < questionBank.length; i++){
        const q = questionBank[i];
        const userAnswer = userAnswers[q.id] || 'æœªä½œç­”';
        const correctAnswer = q.answer || 'æœªçŸ¥';
        const isCorrect = q.answer && userAnswer === q.answer;
        if(isCorrect) correct++;
        details += `<tr style="background: ${isCorrect ? '#d4edda' : '#f8d7da'}"><td>${i+1}</td><td>${userAnswer}</td><td>${correctAnswer}</td><td>${isCorrect ? 'âœ“' : 'âœ—'}</td></tr>`;
      }
      const score = Math.round(correct/total*100);
      const resultWindow = window.open('', '_blank', 'width=900,height=700,scrollbars=yes');
      resultWindow.document.write(`
        <!DOCTYPE html><html><head><title>è€ƒè¯•æˆç»©å•</title><meta charset="utf-8"><style>body{font-family:Arial,sans-serif;padding:20px;background:#f8f9fa;}.header{text-align:center;margin-bottom:30px;}.score-card{background:white;padding:30px;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);margin-bottom:20px;}.score{font-size:48px;font-weight:bold;color:${score >= 60 ? '#28a745' : '#dc3545'};text-align:center;}.score-label{text-align:center;color:#666;margin-bottom:20px;}table{width:100%;border-collapse:collapse;margin-top:20px;}th,td{padding:12px;text-align:center;border:1px solid #ddd;}th{background:#007bff;color:white;}.summary{background:white;padding:20px;border-radius:10px;margin-top:20px;}.print-btn{padding:10px 20px;background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;}</style></head><body>
          <div class="header"><h1>ğŸ“ è€ƒè¯•æˆç»©å•</h1><p>è€ƒè¯•æ—¶é—´ï¼š${new Date().toLocaleString()}</p></div>
          <div class="score-card"><div class="score-label">æ‚¨çš„å¾—åˆ†</div><div class="score">${correct} / ${total}</div><div style="text-align:center;font-size:24px;color:#666;">æ­£ç¡®ç‡ï¼š${score}%</div></div>
          <div class="summary"><h3>ğŸ“Š ç­”é¢˜ç»Ÿè®¡</h3><ul><li>æ€»é¢˜æ•°ï¼š${total}</li><li>å·²ä½œç­”ï¼š${answered}</li><li>æ­£ç¡®ï¼š${correct}</li><li>é”™è¯¯ï¼š${total-correct}</li></ul></div>
          <table><thead><tr><th>é¢˜å·</th><th>æ‚¨çš„ç­”æ¡ˆ</th><th>æ­£ç¡®ç­”æ¡ˆ</th><th>ç»“æœ</th></tr></thead><tbody>${details}</tbody></table>
          <div style="text-align:center;margin-top:30px;"><button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°æˆç»©å•</button></div>
        </body></html>`);
      resultWindow.document.close();
      updateScore();
      showQuestion(currentIndex);
      alert(`ğŸ‰ è€ƒè¯•ç»“æŸï¼\næ‚¨çš„å¾—åˆ†ï¼š${correct} / ${total} (${score}%)\n\nå·²åœ¨æ–°çª—å£æ˜¾ç¤ºè¯¦ç»†æˆç»©å•ã€‚`);
    };
  });
  </script>
</body>
</html>